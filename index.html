
<!DOCTYPE html>
<html lang="fr">
<head>
  <meta charset="UTF-8">
  <title>Prise de présence</title>
  <style>
    table, th, td { border: 1px solid black; border-collapse: collapse; padding: 5px; }
    select, input[type="number"] { width: 100%; }
    .minutes { display: none; }
  </style>
</head>
<body>
  <h2>Prise de présence</h2>
  <label for="cohorte">Cohorte :</label>
  <select id="cohorte">
    <option value="SASI-2025">SASI-2025</option>
    <option value="SASI-2026">SASI-2026</option>
  </select>
  <label for="date">Date :</label>
  <input type="date" id="date">

  <table id="presenceTable">
    <thead>
      <tr>
        <th>Nom</th>
        <th>Prénom</th>
        <th>No fiche</th>
        <th>P1</th>
        <th>P2</th>
        <th>P3</th>
        <th>P4</th>
        <th>P5</th>
        <th>P6</th>
      </tr>
    </thead>
    <tbody>
      <tr>
        <td>Dupont</td>
        <td>Jean</td>
        <td>12345</td>
        <td><select onchange="toggleMinutes(this)"><option>Présent</option><option>Retard</option><option>Départ hâtif</option><option>Rencontre SEC</option></select><input class="minutes" type="number" placeholder="min"></td>
        <td><select onchange="toggleMinutes(this)"><option>Présent</option><option>Retard</option><option>Départ hâtif</option><option>Rencontre SEC</option></select><input class="minutes" type="number" placeholder="min"></td>
        <td><select onchange="toggleMinutes(this)"><option>Présent</option><option>Retard</option><option>Départ hâtif</option><option>Rencontre SEC</option></select><input class="minutes" type="number" placeholder="min"></td>
        <td><select onchange="toggleMinutes(this)"><option>Présent</option><option>Retard</option><option>Départ hâtif</option><option>Rencontre SEC</option></select><input class="minutes" type="number" placeholder="min"></td>
        <td><select onchange="toggleMinutes(this)"><option>Présent</option><option>Retard</option><option>Départ hâtif</option><option>Rencontre SEC</option></select><input class="minutes" type="number" placeholder="min"></td>
        <td><select onchange="toggleMinutes(this)"><option>Présent</option><option>Retard</option><option>Départ hâtif</option><option>Rencontre SEC</option></select><input class="minutes" type="number" placeholder="min"></td>
      </tr>
    </tbody>
  </table>

  <button onclick="handleSubmit()">Enregistrer les présences</button>

  <script>
    function toggleMinutes(select) {
      const input = select.nextElementSibling;
      if (['Retard', 'Départ hâtif', 'Rencontre SEC'].includes(select.value)) {
        input.style.display = 'inline';
      } else {
        input.style.display = 'none';
        input.value = '';
      }
    }

    function collectPresenceData() {
      const table = document.getElementById("presenceTable");
      const rows = table.querySelectorAll("tbody tr");
      const data = [];
      const date = document.getElementById("date").value;
      const cohorte = document.getElementById("cohorte").value;

      rows.forEach(row => {
        const cells = row.querySelectorAll("td");
        const nom = cells[0].innerText.trim();
        const prenom = cells[1].innerText.trim();
        const noFiche = cells[2].innerText.trim();

        for (let i = 3; i < cells.length; i++) {
          const periode = "P" + (i - 2);
          const statut = cells[i].querySelector("select").value;
          const minutes = cells[i].querySelector("input").value || "0";

          data.push({
            Nom: nom,
            Prenom: prenom,
            NoFiche: noFiche,
            Cohorte: cohorte,
            Date: date,
            Periode: periode,
            Statut: statut,
            Minutes: minutes
          });
        }
      });

      return data;
    }

    async function submitToForms(data) {
      const formUrl = "https://forms.office.com/Pages/ResponsePage.aspx?id=uFroQ0R2NE-MUduY9W7U5ABC1eJa4ipCiZQrizC2UWVUN1JGRFpROTdTSjRXRExKUFI2MzhXU0k4OC4u";
      for (const item of data) {
        const formData = new FormData();
        formData.append("Nom", item.Nom);
        formData.append("Prénom", item.Prenom);
        formData.append("No fiche", item.NoFiche);
        formData.append("Cohorte", item.Cohorte);
        formData.append("Date", item.Date);
        formData.append("Période", item.Periode);
        formData.append("Statut présence", item.Statut);
        formData.append("Minutes d'absence", item.Minutes);

        await fetch(formUrl, {
          method: "POST",
          mode: "no-cors",
          body: formData
        });
      }
      alert("Présences envoyées !");
    }

    async function handleSubmit() {
      const data = collectPresenceData();
      await submitToForms(data);
    }
  </script>
</body>
</html>
